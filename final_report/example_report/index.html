<!DOCTYPE html>
<html>
<title>Sakana Milk Battles: The Game</title>

<xmp theme="united" style="display:none;">
# Overview

This entire page is written using [markdown](https://github.com/adam-p/markdown-here/wiki/Markdown-Cheatsheet), which let's you generate cleaner-documents that can be readily rendered in a lot of environments (including the web).  In the context of this template, the markdown is interpretted by a javascript library for you found <a href="http://strapdownjs.com/" target="_blank">here</a>.  This library also let's you pretty conveniently change the theme to one of about a dozen options (See the link). You can also always fall back on traditional html <a href="https://en.wikipedia.org/wiki/Markdown" target="_blank">as I am doing in this link and the previous one</a>.  Feel free to ask questions on piazza, but hopefully this document provides a good list of examples of how to do most things.  

You do not have to use this template. All we want is a nice, clean web-friend report so you can do it in one page as shown here, or in multiple linked pages. However you'd like.  

## Overall Design

Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore
et dolore magna aliqua.  Random Words.  Random Words. This is America. This is America. Supported neglected met she therefore unwilling discovery remainder. Way sentiments two indulgence uncommonly own. Diminution to frequently sentiments he connection continuing indulgence. An my exquisite conveying up defective. Shameless see the tolerably how continued. She enable men twenty elinor points appear. Whose merry ten yet was men seven ought balls. 

Image example:

<center>
	<img src="./media/board_v1.jpg" width="300"/>
</center>

Both rest of know draw fond post as. It agreement defective to excellent. Feebly do engage of narrow. Extensive repulsive belonging depending if promotion be zealously as. Preference inquietude ask now are dispatched led appearance. Small meant in so doubt hopes. Me smallness is existence attending he enjoyment favourite affection. Delivered is to ye belonging enjoyment preferred. Astonished and acceptance men two discretion. Law education recommend did objection how old. 

Built purse maids cease her ham new seven among and. Pulled coming wooded tended it answer remain me be. So landlord by we unlocked sensible it. Fat cannot use denied excuse son law. Wisdom happen suffer common the appear ham beauty her had. Or belonging zealously existence as by resources. 

Abilities or he perfectly pretended so strangers be exquisite. Oh to another chamber pleased imagine do in. Went me rank at last loud shot an draw. Excellent so to no sincerity smallness. Removal request delight if on he we. Unaffected in we by apartments astonished to decisively themselves. Offended ten old consider speaking. 

Locally hosted video embedded:

<center>
	<video width="500" height="400" controls>
  <source src="./media/6s08_EX02_final_product.mp4" type="video/mp4" >
Your browser does not support the video tag.
</video>
</center>

<center>
	<iframe src="https://giphy.com/embed/g0vZLllSiQielcNPae" width="480" height="270" frameBorder="0" allowFullScreen></iframe>
</center>




## System Design

Functional block diagram of the system:

<center>
	<img src="./media/systemblockdiagram.jpg" width="600"/>
</center>

Insert description here.

State machine block diagram:

<center>
	<img src="./media/schematic_1.png" width="600"/>
</center>

Insert description here.

Lists are great. This summer I'm going to:

* Eat ice cream
* Explore the websockets capabilities of the ESP32 more
* Work within the Intel/Altera toolchain more

## Documentation of code

The code is primarily on two files: server.py and esp32.ino.

###Server-side code

server.py takes care of all the server-side code, which involves handling GET and POST requests from the ESP32. When these two types of requests are made, the function `request_handler(request)` is called. All GET and POST requests pass in values for `action`, `player_ID`, and `game_ID` as query arguments.

Depending on the value of `action`, which indicates the action that the user just performed in the game, the code will process this accordingly.

####POST Requests

If the request is a POST request and the value of `action` is:

* 2, 3, or 4, the action was a slash, push, or block, respectively.<br/><br/>
The section of the code handling these cases will call the helper function `add_action(game_ID, player_ID, action)`, which updates `gestures_table` with this new action. (Helper functions are described in more detail later.)<br/><br/>
The data from the `game_table` corresponding to the current game is then extracted using the helper function `extract_game_info(game_ID)`.<br/><br/>
If this game is not ongoing (its `game_state` is not `1`), the health of the player who made the POST request, `game_state`, and `game_ID` is returned as a string.<br/><br/>
Otherwise if the game is ongoing, the last gesture from each player that hasn't been taken into account yet is extracted from the database via the helper function `extract_player_gestures(player_1, player_2)`. Based on these gestures, the helper function `health_update(health_1, health_2, action_1, action_2)` returns the updated healths of the two players and `update_game_info(game_ID, health_1, health_2, game_state)` updates the healths and game state in `game_table`.<br/><br/>
The health of the player who made the POST request, `game_state`, and `game_ID` is then returned as a string.<br/><br/>

* 7, the action was a button press, meaning that a player is trying to start a game.<br/><br/>
This section of the code checks `gestures_table` to see if another player has also tried starting a game in the last 3 seconds (and if they haven't already been matched with someone). It gets the most recent entry matching these specifications, creates a new game with both of these players in `game_table`, and marks both of the corresponding entries in the `gestures_table` as matched (`checked=1`). The player who first pressed the button to start the game is `player_1` and the other `player_2`.<br/><br/>
If there are no entries, it returns `"-1,0,-1"`.<br/><br/>

####GET Requests

If the request is a GET request and the value of `action` is:

* 1, the code checks the `game_table` for the most recent entry of an ongoing game where `player_1` matches the `player_ID` passed as an argument. (The player who first pressed the button to start the game never received the game information during their POST request with `action=7`, so they must post GET requests to get this information.) It returns the health of `player_1`, `game_state`, and `game_ID` as a string.

* 8, the code calls the helper function `extract_game_info(game_ID)` and returns the health of the player who made the POST request, `game_state`, and `game_ID` as a string.

Both these requests return `"-1,0,-1"` if the database table query returns no matching entries.

####Helper Functions

* `dict_factory(cursor, row)`: Converts SQL rows to dictionary format. This is used to set the `conn = sqlite3.connect(game_db)` setting so that all queries to the database return a dictionary. Modified from [here](https://stackoverflow.com/a/3300514).

* `add_action(game_ID,player_ID,action_ID,time=now,checked=0)`: Adds an entry to `gestures_table` with the corresponding inputs and returns nothing.

* `update_game_info(game_ID, health_1, health_2, game_state)`:    Goes into `game_table` updates the row with this `game_ID` with these values. Returns game state.

* `extract_game_info(game_ID)`: Takes in the `game_ID` and goes into `game_table`. Returns the most recent row containing the game_ID as a dictionary of the game information. 

* `extract_player_gestures(player_1, player_2)`: Looks at gesture database and finds the two most recent rows where one is `player_1` and one is `player_2`. The timestamp of the rows must be within one second and `checked` for both must equal `0`. If one of the two rows has an action that is not block, change the `checked` value in that database row to `1`. If they're not, one of the players is `None`. Returns a dictionary of the player name and their action. 

* `health_update(cur_health_1, cur_health_2, action_1, action_2)`: Takes in the current healths of both players and the last action each of them made. Returns the updated healths of both players as a list.


###ESP32 code

Here's some code:

```
//Draws the grid on the display
void drawGrid(void) {

  uint16_t color = TFT_WHITE;
  for (int16_t x = 1; x < GRIDX - 1; x++) {
    for (int16_t y = 1; y < GRIDY - 1; y++) {
      if ((grid[x][y]) != (newgrid[x][y])) {
        if (newgrid[x][y] == 1) color = 0xFFFF; //random(0xFFFF);
        else color = 0;
        tft.fillRect(CELLXY * x, CELLXY * y, CELLXY, CELLXY, color);
      }
    }
  }
}
```

ï»¿yay 


</xmp>

<script src="http://strapdownjs.com/v/0.2/strapdown.js"></script>
</html>